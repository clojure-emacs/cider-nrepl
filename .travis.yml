language: clojure
lein: 2.8.1
sudo: false
cache:
  directories:
    - $HOME/.m2
script:
  - lein source-deps
  - |
    if [ ! -z "$TEST_CMD" ]; then
      $TEST_CMD;
    else
      lein with-profile +$VERSION,+plugin.mranderson/config,+$TEST test;
    fi
env:
  - VERSION="1.7" TEST="test-clj"
  - VERSION="1.7" TEST="test-cljs"
  - VERSION="1.8" TEST="test-clj"
  - VERSION="1.8" TEST="test-cljs"
  - VERSION="1.9" TEST="test-clj"
  - VERSION="1.9" TEST="test-cljs"
jdk:
  - oraclejdk7
  - oraclejdk8
matrix:
  include:
    # Test OpenJDK against latest Clojure stable
    - env:
        - VERSION="1.9"
        - TEST="test-clj"
      jdk: openjdk8
    - env:
        - VERSION="1.9"
        - TEST="test-cljs"
      jdk: openjdk8

    # Test Clojure master against a single JDK
    - env:
        - VERSION="master"
        - TEST="test-clj"
      jdk: oraclejdk8
    - env:
        - VERSION="master"
        - TEST="test-cljs"
      jdk: oraclejdk8

    # eastwood
    - env: TEST_CMD="lein with-profile +1.9,+test-clj,+test-cljs,+eastwood eastwood"
      jdk: oraclejdk8

    # cljfmt
    - env: TEST_CMD="lein with-profile +1.9,+test-clj,+test-cljs,+cljfmt cljfmt check"
      jdk: oraclejdk8

    # codecov
    - env: TEST_CMD="lein with-profile +1.9,+test-clj,+test-cljs,+cloverage cloverage --codecov"
      after_success: bash <(curl -s https://codecov.io/bash) -f target/coverage/codecov.json
      jdk: oraclejdk8

    # coveralls
    - env: TEST_CMD="lein with-profile +1.9,+test-clj,+test-cljs,+cloverage cloverage --coveralls"
      after_success: curl -F json_file=@target/coverage/coveralls.json https://coveralls.io/api/v1/jobs
      jdk: oraclejdk8

  fast_finish: true      # don't wait for allowed failures before build finish
  allow_failures:
    - env: TEST_CMD="lein with-profile +1.9,+test-clj,+test-cljs,+eastwood eastwood"
    - env: TEST_CMD="lein with-profile +1.9,+test-clj,+test-cljs,+cljfmt cljfmt check"
    - env: TEST_CMD="lein with-profile +1.9,+test-clj,+test-cljs,+cloverage cloverage --codecov"
    - env: TEST_CMD="lein with-profile +1.9,+test-clj,+test-cljs,+cloverage cloverage --coveralls"

notifications:
  webhooks:
    urls:
      - https://webhooks.gitter.im/e/14f0f7b4d5b20a70d032
    on_success: change  # options: [always|never|change] default: always
    on_failure: always  # options: [always|never|change] default: always
    on_start: never     # options: [always|never|change] default: always
